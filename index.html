<DOCUMENT filename="index.html">
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MeshCentral Config Generator</title>
<meta name="description" content="Generate custom configuration files for MeshCentral easily with our MeshCentral Config Generator. Simplify setup, customize server options, and deploy your Mesh" />

<!-- Google / Search Engine Tags -->
<meta itemprop="name" content="MeshCentral Config Generator" />
<meta itemprop="description" content="Generate custom configuration files for MeshCentral easily with our MeshCentral Config Generator. Simplify setup, customize server options, and deploy your Mesh" />
<meta itemprop="image" content="https://meshcentraltools.com/images/meshCentralBanner.png" />

<!-- Facebook Meta Tags -->
<meta property="og:url" content="https://config.meshcentraltools.com/" />
<meta property="og:type" content="website" />
<meta property="og:title" content="MeshCentral Config Generator" />
<meta property="og:description" content="Generate custom configuration files for MeshCentral easily with our MeshCentral Config Generator. Simplify setup, customize server options, and deploy your Mesh" />
<meta property="og:image" content="https://meshcentraltools.com/images/meshCentralBanner.png" />

<!-- Twitter Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="MeshCentral Config Generator" />
<meta name="twitter:description" content="Generate custom configuration files for MeshCentral easily with our MeshCentral Config Generator. Simplify setup, customize server options, and deploy your Mesh" />
<meta name="twitter:image" content="https://meshcentraltools.com/images/meshCentralBanner.png" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.6/ajv.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/mode/javascript/javascript.min.js"></script>
<style>
/* === General Styles === */
body {
    font-family: Arial, sans-serif;
    background-color: #1e1e2f;
    color: #aaaaaa;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
	font-size: 14px;
}
h1 { text-align: center; padding: 2px; margin-block-start: 0; margin-block-end: 0;}
#validationMsg { font-size: small; margin-left: 10px; }
.header-top {
	display: flex;
	padding: 10px 20px;
    user-select: none;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #30363d;
    padding-bottom: 10px;
}
.header-left {
    display: flex;
    align-items: center;
    gap: 10px;
}
.header-center {
    display: flex;
    align-items: center;
    gap: 10px;
}
.header-right {
    display: flex;
    align-items: center;
    gap: 10px;
}
.profile-dropdown {
	position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}
.profile-name {
    color: #ddd;
    cursor: pointer;
    text-decoration: none;
    font-weight: 500;
}
.dropdown-menu {
	position: absolute;
    top: 100%;
    right: 0;
    background-color: #21262d;
    border: 1px solid #30363d;
    border-radius: 6px;
    min-width: 150px;
    display: none;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    z-index: 100;
    font-size: smaller;
}
.dropdown-menu a {
	color: #c9d1d8;
    text-decoration: none;
    padding: 8px 16px;
    display: block;
    transition: background-color 0.2s ease;
}
.dropdown-menu a:hover {
    background-color: #444;
}
.logo {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}
.help-icon {
    font-size: 1.2em;
    color: #888;
    cursor: help;
    position: relative;
}
.help-tooltip {
    display: none;
    position: absolute;
    top: 30px;
    left: 0;
    width: 300px;
    background: #333;
    color: #fff;
    padding: 10px;
    border-radius: 6px;
    z-index: 10;
    font-size: 0.9em;
    text-align: left;
}
.container { display: flex; height: calc(100vh - 60px); overflow: hidden; }
.column { overflow: auto; padding: 10px; box-sizing: border-box; }
.column.left { flex-basis: 58%; min-width: 300px; margin-left: 15px; margin-bottom: 10px; padding-top: 0; }
.column.right { flex:1; background:#2a2a3d; margin-right: 15px; margin-bottom: 10px; padding: 0; }
.resizer { width: 15px; cursor: col-resize; background-color: #1e1e2f; }
#formContainer > .field-row { display: none } /* to be checked */

/* CodeMirror styles */
.CodeMirror {
    height: 100%;
    width: 100%;
    border: none;
}
.cm-s-dracula .cm-property { color: #aaaaaa !important; }
.cm-s-dracula .cm-string:not(.cm-property) { color: #0f0 !important; }
.cm-s-dracula .cm-number { color: #ae81ff !important; }
.cm-s-dracula .cm-atom { color: #f92672 !important; }


/* === Accordion === */
.section { border: 1px solid #333; border-radius: 6px; margin-bottom: 5px; }
.section > .header {
    display:flex;
    justify-content:flex-start;
    align-items:center;
    background:#2c2c44;
    padding:6px 10px;
    cursor:pointer;
    user-select:none;
}
.section .title { font-weight:bold; }
.section .badge { font-size:0.6em; background: #0000008a; padding:2px 2px; border-radius:2px; margin-left:10px; }
.tooltip {
    position:absolute;
    background:#333;
    color:#fff;
    padding:3px 6px;
    border-radius:4px;
    font-size:1.1em;
    max-width:280px;
    display:none;
    z-index:10;
}
.content { padding:6px 10px 6px 45px; display:flex; flex-direction:column; gap:6px; }

/* === Field Row === */
.field-row { display:flex; align-items:center; /*gap:6px*/; margin:2px 0; }
.field-row input[type="text"], .field-row input[type="number"], .field-row textarea, .field-row select {
    background:#1e1e2f;
    color:#0f0;
    border: 1px solid #55555530;
    border-radius:4px;
    padding:4px 6px;
    flex:1;
	margin-left: 45px;
}
.field-row button { margin-left:6px; cursor:pointer; border:none; border-radius:4px; padding:4px 8px; background:#444; color:#ddd; font-size: 0.7em; }
.field-row button:hover { background:#555; }
.field-row .badge { font-size:0.6em; background: #0000008a; padding:2px 2px; border-radius:2px; margin-left:10px; cursor: default; user-select: none;}
.field-row .tooltip-icon { font-size:0.7em; cursor: default; opacity: 0.9; color: #888; margin-left:4px; user-select: none;}
.three-state-toggle { user-select: none; }


.section .header .tooltip-icon {
    margin-left: 4px;
    color: #888;
    cursor: pointer;
    font-size: 0.7em;
    opacity: 0.9;
}

/* === Three State Toggle === */
.three-state-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.7em;
    font-weight: bold;
    border: 1px solid #555;
    tabindex: 0;
    margin-left: auto;
}
.three-state-toggle:hover {
    opacity: 0.8;
    transform: scale(1.05);
}
.three-state-toggle[data-state="unset"] {
    background: #40405e6e;
    color: #dddddd6e;
}
.three-state-toggle[data-state="true"] {
    background: #4caf50;
    color: white;
}
.three-state-toggle[data-state="false"] {
    background: #b91c1c;
    color: white;
}
.three-state-toggle .label {
    display: block;
    text-transform: lowercase;
}

/* === Upload Button === */
#uploadLabel {
	background-color: #2c2c44 !important;
    color: #c9d1d8;
    border: 1px solid #30363d;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease, transform 0.1s ease;
}
#uploadLabel:hover { background:#555 !important; }
#uploadConfig { display:none; }

/* === Download Button === */
#downloadBtn {
	background-color: #2c2c44 !important;
    color: #c9d1d8;
    border: 1px solid #30363d;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease, transform 0.1s ease;
}
#downloadBtn:hover { background:#555 !important; }

/* === Copy Button === */
#copyBtn {
	background-color: #2c2c44 !important;
    color: #c9d1d8;
    border: 1px solid #30363d;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease, transform 0.1s ease;
    margin-left: 5px;
}
#copyBtn:hover { background:#555 !important; }
#copyBtn.copied {
    background-color: #4caf50 !important;
    color: white;
}

/* === Scrollbars Dark === */
::-webkit-scrollbar { width:10px; height:10px; }
::-webkit-scrollbar-thumb { background:#555; border-radius:5px; }
::-webkit-scrollbar-track { background:#222; }

/* Mobile adaptations */
@media (max-width: 768px) {
    .header-top {
        flex-direction: column;
        gap: 10px;
    }
    #validationMsg {
        position: static;
        margin-top: 0;
    }
    .container {
        flex-direction: column;
        height: auto;
    }
    .column.left, .column.right {
        flex-basis: auto;
        margin: 0;
        padding: 10px;
    }
    .resizer {
        display: none;
    }
    .help-tooltip {
        left: auto;
        right: 0;
        width: 90vw;
    }
}
</style>
</head>
<body>

<div class="header-top">
    <div class="header-left">
        <h1 style="margin: 0; padding: 0;">MeshCentral Config Generator</h1>
        <span class="help-icon">?
            <div class="help-tooltip">
                <p>This app is a configuration generator for MeshCentral, using the official schema from <a href="https://raw.githubusercontent.com/Ylianst/MeshCentral/master/meshcentral-config-schema.json" target="_blank" style="color: #0f0;">MeshCentral Schema</a>.</p>
                <p>Objective: Easily create or edit config.json files for MeshCentral servers.</p>
                <p>How to use:</p>
                <ul>
                    <li>Optionally upload an existing config.json to edit.</li>
                    <li>Fill in or modify fields in the form.</li>
                    <li>Download the generated config.json.</li>
                </ul>
            </div>
        </span>
        <div id="validationMsg"></div>
    </div>
    <div class="header-right">
        <label id="uploadLabel">Upload
            <input type="file" id="uploadConfig" accept=".json, .txt">
        </label>
        <button id="downloadBtn">Download</button>
        <button id="copyBtn">Copy</button>
        <div onclick="toggleDropdown()"class="profile-dropdown">
            <img src="https://avatars.githubusercontent.com/u/106290334" alt="Logo" class="logo">
            <span class="profile-name">Melo</span>
            <div class="dropdown-menu" id="dropdown-menu">
                <a href="https://github.com/Melo-Professional/" target="_blank">My GitHub</a>
                <a href="https://sanitizer.meshcentraltools.com/" target="_blank">Config Sanitizer</a>
                <a href="https://github.com/Melo-Professional/MeshCentral-Stylish-UI" target="_blank">Stylish UI</a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="column left" id="formContainer"></div>
	<div class="resizer"></div>
    <div class="column right">
        <textarea id="jsonPreview"></textarea>
    </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
function toggleDropdown() {
    document.getElementById("dropdown-menu").style.display = 
        document.getElementById("dropdown-menu").style.display === "block" ? "none" : "block";
}

let schema = null;
let ajv = new Ajv({ allErrors:true, verbose:true, schemaId:'id' });
let configData = {};
let originalData = null;
let properties = null;
const tooltip = document.getElementById('tooltip');
let editor;

// Help tooltip hover fix
let timeout;
const helpIcon = document.querySelector('.help-icon');
const helpTooltip = document.querySelector('.help-tooltip');
helpIcon.addEventListener('mouseenter', () => {
  helpTooltip.style.display = 'block';
});
helpIcon.addEventListener('mouseleave', () => {
  timeout = setTimeout(() => {
    helpTooltip.style.display = 'none';
  }, 300);
});
helpTooltip.addEventListener('mouseenter', () => {
  clearTimeout(timeout);
});
helpTooltip.addEventListener('mouseleave', () => {
  helpTooltip.style.display = 'none';
});

// Function to recursively remove keys starting with '_' 
function cleanUnderscore(obj) {
  if (typeof obj !== 'object' || obj === null) return obj;
  if (Array.isArray(obj)) return obj.map(cleanUnderscore);
  const newObj = {};
  for (let key in obj) {
    if (key.startsWith('_')) continue;
    newObj[key] = cleanUnderscore(obj[key]);
  }
  return newObj;
}

// Case insensitive deep merge
function deepMerge(target, source, ignoreCase = true) {
  if (typeof target !== 'object' || target === null || typeof source !== 'object' || source === null) {
    return source;
  }
  for (let key in source) {
    if (source.hasOwnProperty(key)) {
      let targetKey = key;
      if (ignoreCase) {
        const lowerKey = key.toLowerCase();
        targetKey = Object.keys(target).find(k => k.toLowerCase() === lowerKey) || key;
      }
      if (typeof source[key] === 'object' && source[key] !== null && !Array.isArray(source[key])) {
        if (!target.hasOwnProperty(targetKey)) {
          target[targetKey] = {};
        }
        deepMerge(target[targetKey], source[key], ignoreCase);
      } else if (Array.isArray(source[key])) {
        target[targetKey] = [...source[key]];
      } else {
        target[targetKey] = source[key];
      }
    }
  }
  return target;
}

// Case insensitive get nested value
function getNestedValue(obj, path, ignoreCase = true) {
  const keys = path.split('.');
  let val = obj;
  for(let k of keys) {
    if (k === '') {
      val = val?.[''];
      if (val === undefined) return undefined;
      continue;
    }
    if (ignoreCase) {
      const lowerK = k.toLowerCase();
      const found = Object.keys(val).find(key => key.toLowerCase() === lowerK);
      if (found === undefined) return undefined;
      val = val[found];
    } else {
      val = val?.[k];
    }
    if (val === undefined) return undefined;
  }
  return val;
}

// Resizer
let isResizing = false;
let startX, startWidth;
document.querySelector('.resizer').addEventListener('mousedown', e => {
    isResizing = true;
    startX = e.clientX;
    startWidth = document.querySelector('.left').offsetWidth;
    document.addEventListener('mousemove', onResize);
    document.addEventListener('mouseup', onStop);
});
function onResize(e) {
    if (!isResizing) return;
    const dx = e.clientX - startX;
    const newWidth = Math.max(300, Math.min(window.innerWidth - 10, startWidth + dx)); // Constrain width to prevent overflow
    document.querySelector('.left').style.flexBasis = newWidth + 'px';
}
function onStop() {
    isResizing = false;
    document.removeEventListener('mousemove', onResize);
    document.removeEventListener('mouseup', onStop);
}

// TAB navigation
document.addEventListener('keydown', e => {
    if (e.key === 'Tab') {
        e.preventDefault();
        let current = document.activeElement;
        if (!current.matches('input[type="text"], input[type="number"], textarea, select, .three-state-toggle, button')) return;
        let allTabbables = Array.from(document.querySelectorAll('input[type="text"], input[type="number"], textarea, select, .three-state-toggle, button'));
        let index = allTabbables.indexOf(current);
        if (index === -1) return;
        let nextIndex = e.shiftKey ? (index - 1 + allTabbables.length) % allTabbables.length : (index + 1) % allTabbables.length;
        let next = allTabbables[nextIndex];
        next.focus();
        expandPathTo(next);
    }
});
function expandPathTo(el) {
    let parent = el.closest('.content');
    while (parent) {
        parent.style.display = 'flex';
        parent = parent.parentNode.closest('.content');
    }
}

// Copy functionality
document.getElementById('copyBtn').addEventListener('click', async function() {
    try {
        const jsonContent = editor.getValue();
        await navigator.clipboard.writeText(jsonContent);
        
        // Visual feedback
        const btn = this;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        
        // Reset after 2 seconds
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('copied');
        }, 2000);
    } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = editor.getValue();
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        // Visual feedback
        const btn = this;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('copied');
        }, 2000);
    }
});

// Download
document.getElementById('downloadBtn').addEventListener('click', function() {
    const data = collectData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'config.json';
    a.click();
    URL.revokeObjectURL(url);
});

async function loadSchema() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/Ylianst/MeshCentral/master/meshcentral-config-schema.json');
        schema = await response.json();
        properties = schema.properties;
        document.getElementById('validationMsg').innerHTML = '<span style="color:#0f0"><a href="https://raw.githubusercontent.com/Ylianst/MeshCentral/master/meshcentral-config-schema.json" target="_blank" style="color:#0f0; text-decoration:underline;">Schema</a> loaded, ready to go!</span>';
        generateForm(properties, '', document.getElementById('formContainer'), 0, false);
        updatePreview();
    } catch(e){
        document.getElementById('validationMsg').innerHTML = '<span style="color:red">Error loading <a href="https://raw.githubusercontent.com/Ylianst/MeshCentral/master/meshcentral-config-schema.json" target="_blank" style="color:red; text-decoration:underline;">schema</a>: '+e.message+'</span>';
    }
}


function generateForm(props, parentKey, container, level=0, expand=false){
    Object.keys(props).forEach(key=>{
        if(key.startsWith('_')) return; // Skip keys starting with _
        const prop = props[key];
        if(key === 'domains'){
            const section = document.createElement('div'); section.className='section';
            const header = document.createElement('div'); header.className='header';
            const title = document.createElement('div'); title.className='title'; 
            title.textContent = key;
            const badge = document.createElement('span'); badge.className='badge'; badge.textContent=prop.type;
            title.appendChild(badge);
            header.appendChild(title);

            if(prop.description){
                const ti = document.createElement('span'); ti.className='tooltip-icon'; ti.textContent='?';
                ti.onmouseenter = e=>{tooltip.style.display='block'; tooltip.textContent=prop.description; tooltip.style.left=(e.pageX+10)+'px'; tooltip.style.top=(e.pageY+10)+'px';};
                ti.onmouseleave = ()=>{tooltip.style.display='none';};
                header.appendChild(ti);
            }

            const content = document.createElement('div'); content.className='content'; 
            content.id = 'domainsContent';
            content.style.display = expand ? 'flex':'none';
            header.onclick = ()=>{ content.style.display = content.style.display==='none'?'flex':'none'; };
            section.appendChild(header); section.appendChild(content);

            // Default domain
            const defaultDomainSection = document.createElement('div'); defaultDomainSection.className='section';
            const dheader = document.createElement('div'); dheader.className='header';
            const dtitle = document.createElement('div'); dtitle.className='title'; 
            dtitle.textContent = 'Default Domain ("")';
            dheader.appendChild(dtitle);
            const dcontent = document.createElement('div'); dcontent.className='content'; 
            dcontent.style.display = 'flex';
            dheader.onclick = ()=>{ dcontent.style.display = dcontent.style.display==='none'?'flex':'none'; };
            defaultDomainSection.appendChild(dheader); defaultDomainSection.appendChild(dcontent);
            generateForm(prop.additionalProperties.properties, 'domains.', dcontent, level+2, true);
            content.appendChild(defaultDomainSection);

            // Add Domain row
            const addDomainRow = document.createElement('div'); addDomainRow.className = 'field-row';
            addDomainRow.id = 'addDomainRow';
            const nameLabel = document.createElement('span'); nameLabel.textContent = 'New Domain Name: ';
            nameLabel.style.fontWeight = 'bold';
            const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.id = 'newDomainName'; nameInput.placeholder = 'Enter domain name';
            const addBtn = document.createElement('button'); addBtn.textContent = 'Add Domain';
            addBtn.onclick = () => addDomain(content, addDomainRow);
            addDomainRow.appendChild(nameLabel);
            addDomainRow.appendChild(nameInput);
            addDomainRow.appendChild(addBtn);
            content.appendChild(addDomainRow);

            container.appendChild(section);
        } else if(key === 'sms') {
            const section = document.createElement('div'); section.className='section';
            const header = document.createElement('div'); header.className='header';
            const title = document.createElement('div'); title.className='title'; 
            title.textContent = key;
            const badge = document.createElement('span'); badge.className='badge'; badge.textContent='object';
            title.appendChild(badge);
            header.appendChild(title);

            if(prop.description){
                const ti = document.createElement('span'); ti.className='tooltip-icon'; ti.textContent='?';
                ti.onmouseenter = e=>{tooltip.style.display='block'; tooltip.textContent=prop.description; tooltip.style.left=(e.pageX+10)+'px'; tooltip.style.top=(e.pageY+10)+'px';};
                ti.onmouseleave = ()=>{tooltip.style.display='none';};
                header.appendChild(ti);
            }

            const content = document.createElement('div'); content.className='content'; 
            content.style.display = expand ? 'flex':'none';
            header.onclick = ()=>{ content.style.display = content.style.display==='none'?'flex':'none'; };
            section.appendChild(header); section.appendChild(content);

            // Provider select
            const providerRow = document.createElement('div'); providerRow.className='field-row';
            const providerLabel = document.createElement('span'); providerLabel.textContent = 'provider: ';
            providerLabel.style.fontWeight = 'bold';
            const providerSelect = document.createElement('select'); providerSelect.id = 'sms.provider';
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Select provider';
            providerSelect.appendChild(emptyOption);
            const providers = ['twilio', 'plivo', 'telnyx', 'url'];
            providers.forEach(p => {
                const option = document.createElement('option'); option.value = p; option.textContent = p;
                providerSelect.appendChild(option);
            });
            providerSelect.onchange = function() {
                content.querySelectorAll('.section[data-provider]').forEach(s => { s.style.display = 'none'; });
                const selectedSection = content.querySelector(`.section[data-provider="${this.value}"]`);
                if (selectedSection) {
                    selectedSection.style.display = 'flex';
                }
                updatePreview();
            };
            providerRow.appendChild(providerLabel);
            providerRow.appendChild(providerSelect);
            content.appendChild(providerRow);

            // Sections for each provider
            providers.forEach(provider => {
                const pSection = document.createElement('div'); pSection.className = 'section'; pSection.dataset.provider = provider;
                const pHeader = document.createElement('div'); pHeader.className = 'header';
                const pTitle = document.createElement('div'); pTitle.className = 'title'; pTitle.textContent = provider;
                pHeader.appendChild(pTitle);
                const pContent = document.createElement('div'); pContent.className = 'content'; pContent.style.display = 'none';
                pHeader.onclick = () => { pContent.style.display = pContent.style.display === 'none' ? 'flex' : 'none'; };
                pSection.appendChild(pHeader); pSection.appendChild(pContent);

                let fields = [];
                if (provider === 'twilio') {
                    fields = ['sid', 'auth', 'from'];
                } else if (provider === 'plivo') {
                    fields = ['id', 'token', 'from'];
                } else if (provider === 'telnyx') {
                    fields = ['apikey', 'from'];
                } else if (provider === 'url') {
                    fields = ['url'];
                }

                fields.forEach(f => {
                    const row = document.createElement('div'); row.className = 'field-row';
                    const label = document.createElement('span'); label.textContent = f + ': '; label.style.fontWeight = 'bold';
                    const input = document.createElement('input'); input.type = 'text'; input.id = `sms.${f}`;
                    input.oninput = updatePreview;
                    input.placeholder = f.toUpperCase();
                    row.appendChild(label);
                    row.appendChild(input);
                    pContent.appendChild(row);
                });

                content.appendChild(pSection);
            });

            container.appendChild(section);
        } else if ((prop.type === 'object' || (Array.isArray(prop.type) && prop.type.includes('object'))) && prop.properties) {
            const section = document.createElement('div'); section.className='section';
            const header = document.createElement('div'); header.className='header';
            const title = document.createElement('div'); title.className='title'; 
            title.textContent = key;
            const badge = document.createElement('span'); badge.className='badge'; badge.textContent=prop.type;
            title.appendChild(badge);
            header.appendChild(title);

            if(prop.description){
                const ti = document.createElement('span'); ti.className='tooltip-icon'; ti.textContent='?';
                ti.onmouseenter = e=>{tooltip.style.display='block'; tooltip.textContent=prop.description; tooltip.style.left=(e.pageX+10)+'px'; tooltip.style.top=(e.pageY+10)+'px';};
                ti.onmouseleave = ()=>{tooltip.style.display='none';};
                header.appendChild(ti);
            }

            const content = document.createElement('div'); content.className='content'; 
            content.style.display = expand ? 'flex':'none';
            header.onclick = ()=>{ content.style.display = content.style.display==='none'?'flex':'none'; };
            section.appendChild(header); section.appendChild(content);
            const subParentKey = parentKey ? parentKey + '.' + key : key;
            generateForm(prop.properties, subParentKey, content, level+1, false);
            container.appendChild(section);
        } else {
            const row = document.createElement('div'); row.className='field-row';
            const keySpan = document.createElement('span'); keySpan.textContent = key + ': ';
            keySpan.style.fontWeight = 'bold';
            row.appendChild(keySpan);
            const badge = document.createElement('span'); badge.className='badge'; badge.textContent=prop.type;
            row.appendChild(badge);

            let input;
            const fullId = parentKey ? parentKey + '.' + key : key;
            let placeholder = prop.description || 'Value';

            if(prop.type === 'boolean' || (Array.isArray(prop.type) && prop.type.includes('boolean'))){
                const toggle = document.createElement('div'); toggle.className = 'three-state-toggle'; toggle.id = fullId; toggle.dataset.state = 'unset'; toggle.tabIndex = 0;
                const labelSpan = document.createElement('span'); labelSpan.className = 'label'; labelSpan.textContent = 'unset';
                toggle.appendChild(labelSpan);
                const toggleState = function() {
                    const states = ['unset', 'true', 'false'];
                    let idx = states.indexOf(toggle.dataset.state);
                    let next = states[(idx + 1) % 3];
                    toggle.dataset.state = next;
                    labelSpan.textContent = next;
                    updatePreview();
                };
                toggle.addEventListener('click', toggleState);
                toggle.addEventListener('keydown', function(e) {
                    if (e.key === ' ' || e.key === 'Enter') {
                        e.preventDefault();
                        toggleState();
                    }
                });
                if(prop.description){
                    const ti = document.createElement('span'); ti.className='tooltip-icon'; ti.textContent='?';
                    ti.onmouseenter = e=>{tooltip.style.display='block'; tooltip.textContent=prop.description; tooltip.style.left=(e.pageX+10)+'px'; tooltip.style.top=(e.pageY+10)+'px';};
                    ti.onmouseleave = ()=>{tooltip.style.display='none';};
                    row.appendChild(ti);
                }
                row.appendChild(toggle);
            } else {
                if(prop.type==='string' || (Array.isArray(prop.type) && prop.type.includes('string'))){
                    input = document.createElement('input'); input.type='text'; input.id=fullId;
                } else if(prop.type==='number' || (Array.isArray(prop.type) && prop.type.includes('number'))){
                    input = document.createElement('input'); input.type='number'; input.id=fullId;
				} else if(prop.type==='integer' || (Array.isArray(prop.type) && prop.type.includes('integer'))){
					input = document.createElement('input'); input.type='number'; input.id=fullId; input.step='1';
                } else if(prop.type==='array' || (Array.isArray(prop.type) && prop.type.includes('array'))){
                    input = document.createElement('textarea'); input.id=fullId;
                    placeholder = prop.description || 'JSON array';
                } else {
                    input = document.createElement('textarea'); input.id=fullId;
                }
                input.placeholder=placeholder;
                input.oninput=updatePreview;
                if(prop.description){
                    const ti = document.createElement('span'); ti.className='tooltip-icon'; ti.textContent='?';
                    ti.onmouseenter = e=>{tooltip.style.display='block'; tooltip.textContent=prop.description; tooltip.style.left=(e.pageX+10)+'px'; tooltip.style.top=(e.pageY+10)+'px';};
                    ti.onmouseleave = ()=>{tooltip.style.display='none';};
                    row.appendChild(ti);
                }
                row.appendChild(input);
            }
            
            if(prop.type==='string' && (key.toLowerCase().includes('secret') || key.toLowerCase().includes('key')) && !key.toLowerCase().includes('cert')){
                const genBtn = document.createElement('button'); genBtn.textContent='Generate Key';
                genBtn.onclick=e=>{ e.preventDefault(); input.value=randomKey(); updatePreview(); };
                row.appendChild(genBtn);
            }
            container.appendChild(row);
        }
    });
}

function addDomainWithName(content, domainName) {
    const section = document.createElement('div'); section.className='section';
    section.dataset.domainName = domainName;
    const header = document.createElement('div'); header.className='header';
    const title = document.createElement('div'); title.className='title'; 
    title.textContent = domainName;
    header.appendChild(title);
    const content2 = document.createElement('div'); content2.className='content'; 
    content2.style.display = 'flex';
    header.onclick = ()=>{ content2.style.display = content2.style.display==='none'?'flex':'none'; };
    section.appendChild(header); section.appendChild(content2);
    generateForm(schema.properties.domains.additionalProperties.properties, `domains.${domainName}`, content2, 0, true);
    content.insertBefore(section, document.getElementById('addDomainRow'));
}

function addDomain(content, addDomainRow) {
    const nameInput = document.getElementById('newDomainName');
    const domainName = nameInput.value.trim();
    if(!domainName) return;
    addDomainWithName(content, domainName);
    nameInput.value = '';
    updatePreview();
}

function randomKey(){ 
    const array=new Uint8Array(32); crypto.getRandomValues(array);
    return Array.from(array).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function convertStringValue(val, prop) {
  if (typeof val !== 'string') return val;
  // Boolean conversion
  if (val === 'true') return true;
  if (val === 'false') return false;
  // Integer number conversion
  if (/^-?\d+$/.test(val)) {
    return Number(val);
  }
  // JSON array/object conversion
  const trimmed = val.trim();
  if (trimmed && (trimmed.startsWith('[') || trimmed.startsWith('{'))) {
    try {
      return JSON.parse(trimmed);
    } catch (e) {
      // Keep as string
    }
  }
  return val;
}

function collectSub(props, parentKey) {
  const sub = {};
  Object.keys(props).forEach(key => {
    if(key.startsWith('_')) return;
    const fullId = parentKey + '.' + key;
    const prop = props[key];
    if ((prop.type === 'object' || (Array.isArray(prop.type) && prop.type.includes('object'))) && prop.properties) {
      const subSub = collectSub(prop.properties, fullId);
      if (Object.keys(subSub).length > 0) {
        sub[key] = subSub;
      }
    } else {
      let val;
      const element = document.getElementById(fullId);
      if (element) {
        if (element.classList && element.classList.contains('three-state-toggle')) {
          const state = element.dataset.state;
          if (state !== 'unset') {
            val = state === 'true';
          }
        } else if (element.value && element.value.trim() !== '' && element.id !== 'newDomainName') {
          if (element.type === 'number') {
            val = Number(element.value);
          } else if (element.tagName.toLowerCase() === 'textarea') {
            try {
              val = JSON.parse(element.value);
            } catch (e) {
              val = element.value;
            }
          } else {
            val = element.value;
          }
          // Convert string values
          val = convertStringValue(val, prop);
        }
      }
      if (val !== undefined) {
        sub[key] = val;
      }
    }
  });
  return sub;
}

function collectSubForSms() {
  const smsObj = {};
  const providerVal = collectTopLeaf('sms.provider');
  if (providerVal && providerVal !== '') {
    smsObj.provider = providerVal;
  }
  const fields = ['sid', 'auth', 'from', 'id', 'token', 'apikey', 'url'];
  fields.forEach(f => {
    const fullId = 'sms.' + f;
    const val = collectTopLeaf(fullId);
    if (val !== undefined && (typeof val !== 'string' || val.trim() !== '')) {
      smsObj[f] = val;
    }
  });
  if (smsObj.provider) {
    return smsObj;
  } else {
    return undefined;
  }
}

function collectTopLeaf(fullId) {
  let val;
  const element = document.getElementById(fullId);
  if (element) {
    if (element.classList && element.classList.contains('three-state-toggle')) {
      const state = element.dataset.state;
      if (state !== 'unset') {
        val = state === 'true';
      }
    } else if (element.value && element.value.trim() !== '' && element.id !== 'newDomainName') {
      if (element.type === 'number') {
        val = Number(element.value);
      } else if (element.tagName.toLowerCase() === 'textarea') {
        try {
          val = JSON.parse(element.value);
        } catch (e) {
          val = element.value;
        }
      } else {
        val = element.value;
      }
      // For top-level, we don't have prop, so simple conversion
      val = convertStringValue(val, {type: 'string'}); // default to string, but convert booleans and integers and json
    }
  }
  return val;
}

function collectData(){
    // Start with a clean base. If originalData exists, use it after cleaning.
    // Otherwise, start with an empty object.
    let obj = {};
    if (originalData) {
        obj = JSON.parse(JSON.stringify(originalData)); // Deep copy originalData
        delete obj["$schema"]; // Remove schema if present
        obj = cleanUnderscore(obj); // Clean keys starting with '_'
    }

    const topProps = schema.properties;
    Object.keys(topProps).forEach(key => {
        if (key.startsWith('_')) return; // Skip internal properties

        // Special handling for 'domains'
        if (key === 'domains') {
            const domainProps = topProps.domains.additionalProperties.properties;
            // Initialize domains object if it doesn't exist
            if (!obj.domains) obj.domains = {};

            // Collect default domain values
            const defaultCollected = collectSub(domainProps, 'domains.');
            obj.domains[''] = deepMerge(obj.domains[''] || {}, defaultCollected, true);

            // Collect values for dynamically added domains
            const domainsContent = document.getElementById('domainsContent');
            if (domainsContent) {
                const sections = domainsContent.querySelectorAll('div[data-domain-name]'); // Select div.section
                sections.forEach(section => {
                    const domainName = section.dataset.domainName;
                    const collected = collectSub(domainProps, `domains.${domainName}`);
                    obj.domains[domainName] = deepMerge(obj.domains[domainName] || {}, collected, true);
                });
            }
        }
        // Special handling for 'settings'
        else if (key === 'settings') {
            const settingsProps = topProps.settings.properties;
            const subObj = collectSub(settingsProps, 'settings');
            obj.settings = deepMerge(obj.settings || {}, subObj, true);
        }
        // Special handling for 'sms'
        else if (key === 'sms') {
            const sub = collectSubForSms();
            if (sub !== undefined) {
                obj.sms = deepMerge(obj.sms || {}, sub, true);
            }
        }
        // General handling for other properties
        else {
            const prop = topProps[key];
            // If it's an object with sub-properties
            if ((prop.type === 'object' || (Array.isArray(prop.type) && prop.type.includes('object'))) && prop.properties) {
                const subObj = collectSub(prop.properties, key);
                if (Object.keys(subObj).length > 0) {
                    obj[key] = deepMerge(obj[key] || {}, subObj, true);
                }
            }
            // If it's a leaf property (not an object with sub-properties)
            else {
                const val = collectTopLeaf(key);
                if (val !== undefined) {
                    obj[key] = val; // Direct assignment for top-level leaves
                } else if (obj.hasOwnProperty(key)) {
                    delete obj[key]; // Remove if the form field is empty and it existed in originalData
                }
            }
        }
    });

    return { "$schema": schema.id, ...obj };
}

// JSON Preview
function updatePreview(){
    const data=collectData();
    editor.setValue(JSON.stringify(data,null,2));
}

// Upload config
document.getElementById('uploadConfig').addEventListener('change', function(e){
    const file = e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
        try{
            const data = JSON.parse(ev.target.result);
            originalData = JSON.parse(JSON.stringify(data));
            // Add extra domains if they exist in the data
            const domainsContent = document.getElementById('domainsContent');
            if (domainsContent && data.domains) {
                Object.keys(data.domains).forEach(domainName => {
                    if (domainName === '') return;
                    if (!domainsContent.querySelector(`[data-domain-name="${domainName}"]`)) {
                        addDomainWithName(domainsContent, domainName);
                    }
                });
            }
            populateForm(data);
            updatePreview();
        } catch(err){ document.getElementById('validationMsg').innerHTML='<span style="color:red">'+err.message+'</span>'; }
    };
    reader.readAsText(file);
});

// Populate form
function populateForm(data){
    // Non-radio inputs
    const nonRadioInputs = document.querySelectorAll('#formContainer input[type="text"], input[type="number"], textarea, select');
    nonRadioInputs.forEach(input => {
        if (input.id === 'newDomainName') return;
        const val = getNestedValue(data, input.id, true);
        if(val !== undefined){
            input.value = typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val);
            expandPathTo(input);
        }
    });
    // Toggles
    const toggles = document.querySelectorAll('.three-state-toggle');
    toggles.forEach(t => {
        const val = getNestedValue(data, t.id, true);
        let state = 'unset';
        if(val === true) state = 'true';
        else if(val === false) state = 'false';
        t.dataset.state = state;
        t.querySelector('.label').textContent = state;
        expandPathTo(t);
    });
    // Special for sms
    const providerSelect = document.getElementById('sms.provider');
    if(providerSelect) {
        const smsData = getNestedValue(data, 'sms', true);
        if(smsData && smsData.provider) {
            providerSelect.value = smsData.provider;
            const content = providerSelect.closest('.content');
            content.querySelectorAll('.section[data-provider]').forEach(s => { s.style.display = 'none'; });
            const selectedSection = content.querySelector(`.section[data-provider="${smsData.provider}"]`);
            if(selectedSection) {
                selectedSection.style.display = 'flex';
            }
        }
    }
}

// Initialize CodeMirror
document.addEventListener('DOMContentLoaded', ()=>{
    editor = CodeMirror.fromTextArea(document.getElementById('jsonPreview'), {
        mode: {name: "javascript", json: true},
        theme: 'dracula',
        lineNumbers: true,
        readOnly: true,
        viewportMargin: Infinity
    });
    loadSchema();
});
</script>
</body>
</html>
</DOCUMENT>
